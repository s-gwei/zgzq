<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.P2020052.mapper.ZLMapper">


    <!-- PERT查询映射结果 -->
    <resultMap id="BaseResultMap" type="org.jeecg.modules.P2020052.pojo.PiplanActivityVo">
        <!--        colum对应数据库的字段,property对应实体类的属性-->
        <result column="activityId" property="activityId"/>
        <result column="targetStartTime" property="targetStartTime"/>
        <result column="byTime" property="byTime"/>
        <result column="expectedFinishTime" property="expectedFinishTime"/>
        <result column="actualStartTime" property="actualStartTime"/>
        <result column="actualEndTime" property="actualEndTime"/>
    </resultMap>

    <!-- 项目风险系数表查询映射结果 -->
    <resultMap id="DaseResultMap" type="org.jeecg.modules.P2020052.pojo.ProjectRiskVo">
        <!--        colum对应数据库的字段,property对应实体类的属性-->
        <result column="project_id" property="projectId"/>
        <result column="project_name" property="name"/>
        <result column="plan_activity_ref_id" property="preRatio"/>
        <result column="plan_start_date" property="startTime"/>
        <result column="standard_deviation_value" property="standardDeviationValue"/>
        <result column="standard_difficulty_value" property="standardDifficultyValue"/>
        <result column="deviation_report" property="deviationReport"/>
        <result column="difficulty_report" property="difficultyReport"/>
    </resultMap>

    <!-- 部门风险系数表查询映射结果 -->
    <resultMap id="CaseResultMap" type="org.jeecg.modules.P2020052.pojo.GroupRiskVo">
        <!--        colum对应数据库的字段,property对应实体类的属性-->
        <result column="plan_activity_ref_id" property="activityId"/>
        <result column="target_start_date" property="actualStartDate"/>
        <result column="standard_work_qty" property="standardWorkQty"/>
        <result column="actual_work_qty" property="actualWorkQty"/>
        <result column="weights" property="weights"/>
        <result column="standard_deviation_value" property="standardDeviationValue"/>
        <result column="standard_difficulty_value" property="standardDifficultyValue"/>
        <result column="deviation_report" property="deviationReport"/>
        <result column="difficulty_report" property="difficultyReport"/>
        <result column="breadth" property="breadth"/>
        <result column="criticality" property="criticality"/>
    </resultMap>

    <select id="pertTable" resultMap="BaseResultMap">
        SELECT
            pa.id AS activityId,
            pa.target_start_date AS targetStartTime,
            pa.target_end_date AS byTime,
            sft.expected_finish_time AS expectedFinishTime,
            pa.actual_start_date AS actualStartTime
        FROM
            piplan_activity pa,
            stexpected_finish_time sft
        WHERE
            pa.id = sft.plan_activity_ref_id
			and pa.id = #{activeId}
    </select>

    <select id="projectWeekCycle" resultMap="BaseResultMap">
SELECT
	a.target_start_date as targetStartTime,
	b.target_end_date as byTime
FROM
	( SELECT piplan_activity.target_start_date, piplan_activity.project_ref_id FROM piplan_activity WHERE piplan_activity.project_ref_id = #{projectId} ORDER BY piplan_activity.target_start_date LIMIT 1 ) a,
	( SELECT piplan_activity.target_end_date, piplan_activity.project_ref_id FROM piplan_activity WHERE piplan_activity.project_ref_id = #{projectId} ORDER BY piplan_activity.target_end_date DESC LIMIT 1 ) b
WHERE
	a.project_ref_id = b.project_ref_id

    </select>

    <!-- 根据用户名查询 -->
    <select id="ProjectRiskTable" resultMap="DaseResultMap">
/*        SELECT
        a.*,
        d.id as project_id,
        d.plan_start_date,
        d.project_name
        FROM
        (
        SELECT
        stproject_instanceotindicator.plan_activity_ref_id,
        stproject_instanceotindicator.standard_deviation_value,
        stproject_instanceotindicator.standard_difficulty_value,
        stproject_instanceotindicator.deviation_report,
        stproject_instanceotindicator.difficulty_report
        FROM
        stproject_instanceotindicator
        WHERE
        stproject_instanceotindicator.plan_activity_ref_id IN (
        SELECT id FROM piplan_activity  pa WHERE pa.project_ref_id = 137722
        )
        ) a,
        (SELECT piproject.id,piproject.plan_start_date, piproject.project_name FROM piproject WHERE id =137722
        ) d
        ORDER BY
        d.id*/

        SELECT
        c.*,
        d.plan_start_date,
        d.project_name
        FROM
        (
        SELECT
        *
        FROM
        (
        SELECT
        stproject_instanceinindicator.plan_activity_ref_id,
        stproject_instanceotindicator.standard_deviation_value,
        stproject_instanceotindicator.standard_difficulty_value,
        stproject_instanceotindicator.deviation_report,
        stproject_instanceotindicator.difficulty_report
        FROM
        stproject_instanceinindicator,
        stproject_instanceotindicator
        WHERE
        <!-- in_code和ot_code 相等代表是同一个任务 -->
        stproject_instanceinindicator.ot_code = stproject_instanceotindicator.CODE
        AND stproject_instanceinindicator.plan_activity_ref_id IN (
        SELECT id FROM piplan_activity  pa WHERE pa.project_ref_id = #{projectId}
         )
        ) a,  <!-- a 表的意思是： 当任务表的项目id与传入项目号相同时，项目所有任务id对应到in表的任务id, 查到任务id, 偏差，困难度   -->
        (SELECT id,pa.project_ref_id as project_id FROM piplan_activity  pa WHERE pa.project_ref_id =#{projectId}
         ) b  <!-- b表的意思是： 选择项目的所有任务的id 和项目Id-->
        WHERE
        a.plan_activity_ref_id = b.id
        ) c,  <!-- c表比a表多了项目id,任务id -->
        (SELECT piproject.id,piproject.plan_start_date, piproject.project_name FROM piproject WHERE id =#{projectId}
        ) d   <!-- d表：项目id ,计划开始时间，项目名字 -->
        WHERE
        c.project_id = d.id
        ORDER BY
        c.project_id
    </select>

        <!-- 根据用户名查询 -->
    <select id="SectorRiskFactor" resultMap="CaseResultMap">
        SELECT
        a.*,
        b.*
        /*        ,
        c.**/
        FROM
        (
        SELECT
        stproject_instanceinindicator.plan_activity_ref_id,
        stproject_instanceinindicator.weights,
        stproject_instanceotindicator.standard_deviation_value,
        stproject_instanceotindicator.standard_difficulty_value,
        stproject_instanceotindicator.deviation_report,
        stproject_instanceotindicator.difficulty_report,
        stproject_instanceotindicator.breadth,
        stproject_instanceotindicator.criticality
        FROM
        stproject_instanceinindicator,
        stproject_instanceotindicator
        WHERE
        stproject_instanceinindicator.ot_code = stproject_instanceotindicator.CODE
        AND stproject_instanceinindicator.plan_activity_ref_id IN (
        SELECT
        id
        FROM
        piplan_activity pa
        WHERE
        piplan_activity.id IN (
        SELECT
        piresource_assignment.plannable_ref_id
        FROM
        piresource_assignment
        WHERE
        /*      piresource_assignment.actual_start_date &gt;= #{startTime}
        AND piresource_assignment.actual_end_date &lt;= #{endTime}
        AND */
        piresource_assignment.rsrc_ref_id IN ( SELECT piresource.id FROM piresource WHERE piresource.user_ref_id in
        <foreach collection="userId" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        )
        )
        <if test="startTime!= null and startTime !=''" >
            and  pa.actual_start_date between  #{startTime}  and #{endTime}
        </if>
        )
        ) a,
        (
        SELECT
        id,
        piplan_activity.actual_work_qty,
        piplan_activity.standard_work_qty,
        piplan_activity.
        FROM
        piplan_activity pa
        WHERE

        piplan_activity.id IN (
        SELECT
        piresource_assignment.plannable_ref_id
        FROM
        piresource_assignment
        WHERE
        /*        piresource_assignment.actual_start_date &gt;= #{startTime}
        AND piresource_assignment.actual_end_date &lt;= #{endTime}
        AND */
        piresource_assignment.rsrc_ref_id IN (
        SELECT piresource.id FROM piresource WHERE piresource.user_ref_id in
        <foreach collection="userId" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
        )
        )
        <if test="startTime!= null and startTime !=''" >
            and  pa.actual_start_date between  #{startTime}  and #{endTime}
        </if>
        ) b
        <!--        ,-->
        <!--        (-->
        <!--        SELECT-->
        <!--        piresource_assignment.plannable_ref_id,-->
        <!--        piresource_assignment.actual_start_date-->
        <!--        FROM-->
        <!--        piresource_assignment-->
        <!--        WHERE-->
        <!--/*        piresource_assignment.actual_start_date &gt;= #{startTime}-->
        <!--        AND piresource_assignment.actual_end_date &lt;= #{endTime}-->
        <!--        AND */-->
        <!--        piresource_assignment.rsrc_ref_id IN (-->
        <!--        SELECT piresource.id FROM piresource WHERE piresource.user_ref_id in-->
        <!--        <foreach collection="userId" item="id" open="(" close=")" separator=",">-->
        <!--            #{id}-->
        <!--        </foreach>-->
        <!--        )-->
        <!--        ) c-->
    </select>

</mapper>